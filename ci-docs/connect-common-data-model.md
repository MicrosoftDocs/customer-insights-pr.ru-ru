---
title: Подключение к папке Common Data Model с помощью учетной записи Azure Data Lake
description: Работа с данными Common Data Model с помощью Azure Data Lake Storage.
ms.date: 09/29/2022
ms.topic: how-to
author: mukeshpo
ms.author: mukeshpo
ms.reviewer: v-wendysmith
manager: shellyha
searchScope:
- ci-data-sources
- ci-create-data-source
- ci-attach-cdm
- customerInsights
ms.openlocfilehash: c12603b9ed8a814356a0f8d0137e97afc749b87c
ms.sourcegitcommit: be341cb69329e507f527409ac4636c18742777d2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/30/2022
ms.locfileid: "9609964"
---
# <a name="connect-to-data-in-azure-data-lake-storage"></a>Подключение к данным в Azure Data Lake Storage

Прием данных в Dynamics 365 Customer Insights с использованием вашей учетной записи Azure Data Lake Storage 2-го поколения. Прием данных может быть полным или добавочным.

## <a name="prerequisites"></a>Предварительные условия

- Прием данных поддерживает только учетные записи Azure Data Lake Storage *2-го поколения*. Вы не можете использовать учетные записи Data Lake Storage 1-го поколения для приема данных.

- У учетной записи Azure Data Lake Storage должно быть [включено иерархическое пространство имен](/azure/storage/blobs/data-lake-storage-namespace). Данные должны храниться в иерархическом формате папок, который определяет корневую папку и имеет вложенные папки для каждой сущности. Подпапки могут иметь папки с полными или инкрементными данными.

- Чтобы пройти аутентификацию с помощью субъекта-службы Azure, убедитесь, что она настроена в вашем клиенте. Для получения дополнительной информации см. раздел [Подключение к учетной записи Azure Data Lake Storage Gen2 с помощью субъекта-службы Azure](connect-service-principal.md).

- Azure Data Lake Storage, к которому требуется подключиться и из которого требуется принимать данные, должно находиться в том же регионе Azure, что и среда Dynamics 365 Customer Insights. Подключения к папке Common Data Model из озера данных в другом регионе Azure не поддерживаются. Чтобы узнать регион среды Azure, перейдите на страницу **Администратор** > **Система** > **Сведения** в Customer Insights.

- Данные, хранящиеся в веб-службах, могут храниться в месте, отличном от того, где данные обрабатываются или хранятся в Dynamics 365 Customer Insights. Импортируя данные или подключаясь к данным, хранящимся в веб-службах, вы соглашаетесь с тем, что данные могут быть переданы и сохранены в Dynamics 365 Customer Insights.  [Подробнее см. в Центре управления безопасностью Майкрософт](https://www.microsoft.com/trust-center).

- Для доступа к учетной записи хранения субъект-служба Customer Insights должна быть в одной из следующих ролей. Дополнительные сведения см. в статье [Предоставление разрешений субъекту-службе для доступа к учетной записи хранения](connect-service-principal.md#grant-permissions-to-the-service-principal-to-access-the-storage-account).
  - Средство чтения данных хранилища BLOB-объектов
  - Владелец данных хранилища BLOB-объектов
  - Участник данных хранилища BLOB-объектов

- Пользователю, который настраивает подключение к источнику данных, требуются как минимум разрешения "Участник данных хранилища BLOB-объектов" в отношении учетной записи хранения.

- Данные в Data Lake Storage должны соответствовать стандарту Common Data Model для хранения ваших данных и иметь манифест Common Data Model для представления схемы файлов данных (*.csv или *.parquet). Манифест должен предоставлять сведения о сущностях, такие как столбцы и типы данных сущности, а также расположение и тип файла данных. Дополнительные сведения см. в разделе [Манифест Common Data Model](/common-data-model/sdk/manifest). Если манифест отсутствует, пользователи-администраторы с правами доступа «Владелец данных BLOB-объекта хранилища» или «Участник данных BLOB-объектов хранилища» могут определить схему при приеме данных.

## <a name="recommendations"></a>Рекомендации

Для оптимальной производительности Customer Insights рекомендует размер раздела не более 1 ГБ, а количество файлов раздела в папке не должно превышать 1000.

## <a name="connect-to-azure-data-lake-storage"></a>Подключение к Azure Data Lake Storage

1. Перейдите в раздел **Данные** > **Источники данных**.

1. Выберите **Добавить источник данных**.

1. Выберите **Azure Data Lake Storage**.

   :::image type="content" source="media/data_sources_ADLS.png" alt-text="Диалоговое окно для ввода сведений о соединении для Azure Data Lake." lightbox="media/data_sources_ADLS.png":::

1. Введите **Имя** для источника данных и, при желании, **Описание**. Имя уникально идентифицирует источник данных, на него ссылаются нижестоящие процессы, и его нельзя изменить.

1. Выберите один из следующих вариантов для параметра **Подключите свое хранилище с использованием**. Дополнительные сведения см. в разделе [Подключение Customer Insights к учетной записи Azure Data Lake Storage 2-го поколения с помощью субъекта-службы Azure](connect-service-principal.md).

   - **Ресурс Azure**: введите **Идентификатор ресурса**. При необходимости, если вы хотите принимать данные из учетной записи хранения через приватный канал Azure, выберите **Включить приватный канал**. Дополнительные сведения см. в разделе [Приватные каналы](security-overview.md#set-up-an-azure-private-link).
   - **Подписка Azure**: выберите **Подписка**, затем **Группа ресурсов** и **Учетная запись хранения**. При необходимости, если вы хотите принимать данные из учетной записи хранения через приватный канал Azure, выберите **Включить приватный канал**. Дополнительные сведения см. в разделе [Приватные каналы](security-overview.md#set-up-an-azure-private-link).
  
   > [!NOTE]
   > Вам потребуется одна из следующих ролей для доступа к контейнеру или учетной записи хранения для создания источника данных:
   >
   >  - Роли "Модуль чтения данных BLOB-объектов хранилища" достаточно для выполнения чтения из учетной записи хранения и загрузки данных в Customer Insights.
   >  - Роли "Участник данных BLOB-объектов хранилища" или "Владелец данных BLOB-объектов хранилища" необходимы, если требуется редактировать файлы манифеста непосредственно в Customer Insights.  
  
1. Выберите название объекта **Контейнер**, который содержит данные и схему (файл model.json или manifest.json), из которых требуется импортировать данные, и выберите **Далее**.
   > [!NOTE]
   > Любой файл model.json или manifest.json, связанный с другим источником данных в среде, не будет отображаться в списке. Однако один и тот же файл model.json или manifest.json можно использовать для источников данных в нескольких средах.

1. Чтобы создать новую схему, перейдите к разделу [Создание нового файла схемы](#create-a-new-schema-file).

1. Чтобы использовать существующую схему, перейдите в папку, содержащую файл model.json или manifest.cdm.json. Вы можете выполнить поиск в каталоге, чтобы найти файл.

1. Выберите файл json, затем выберите **Далее**. Отображается список доступных сущностей.

   :::image type="content" source="media/review-entities.png" alt-text="Диалоговое окно со списком сущностей для выбора":::

1. Выберите сущности, которые требуется включить.

   :::image type="content" source="media/ADLS_required.png" alt-text="Диалоговое окно, показывающее, что требуется для первичного ключа":::

   > [!TIP]
   > Чтобы изменить сущность в интерфейсе редактирования JSON, выберите сущность и затем **Изменить файл схемы**. Внесите изменения и выберите **Сохранить**.

1. Для выбранных сущностей, требующих инкрементного приема, **Обязательно** отображается в поле **Инкрементное обновление**. Для каждой из этих сущностей см. раздел [Настройка инкрементного обновления для источников данных Azure Data Lake](incremental-refresh-data-sources.md).

1. Для выбранных сущностей, для которых первичный ключ не определен, **Обязательно** отображается в поле **Первичный ключ**. Для каждой из этих сущностей:
   1. Выберите **Обязательно**. Открывается панель **Изменение сущности**.
   1. Выберите **первичный ключ**. Первичный ключ — это атрибут, уникальный для сущности. Чтобы атрибут был действительным первичным ключом, он не должен включать повторяющиеся значения, отсутствующие значения или значения NULL. В качестве первичных ключей поддерживаются атрибуты типа данных: строка, целое число, GUID.
   1. При желании измените шаблон раздела.
   1. Выберите **Закрыть**, чтобы сохранить и закрыть панель.

1. Выберите количество параметров **Атрибуты** для каждой включенной сущности. Открывается страница **Управление атрибутами**.

   :::image type="content" source="media/dataprofiling-entities.png" alt-text="Диалоговое окно для выбора профилирования данных.":::

   1. Создавайте новые атрибуты, редактируйте или удаляйте существующие атрибуты. Вы можете изменить имя, формат данных или добавить семантический тип.
   1. Чтобы включить аналитику и другие возможности, выберите **Профилирование данных** для всей сущности или для определенных атрибутов. По умолчанию ни одна сущность не включена для профилирования данных.
   1. Нажмите кнопку **Готово**.

1. Выберите **Сохранить**. Открывается страница **Источники данных** с новым источником данных в статусе **Обновление**.

   [!INCLUDE [progress-details-include](includes/progress-details-pane.md)]

Загрузка данных может занять время. После успешного обновления принятые данные можно проверить на странице [**Сущности**](entities.md).

### <a name="create-a-new-schema-file"></a>Создание новой схемы

1. Выберите **Новый файл схемы**.

1. Введите имя для файла и выберите **Сохранить**.

1. Выберите **Создать сущность**. Открывается панель **Новая сущность**.

1. Введите имя сущности и выберите **Расположение файлов данных**.
   - **Несколько файлов .csv или .parquet**: перейдите в корневую папку, выберите тип шаблона и введите выражение.
   - **Один файл .csv или .parquet**: найдите файл .csv или .parquet и выберите его.

   :::image type="content" source="media/ADLS_new_entity_location.png" alt-text="Диалоговое окно для создания новой сущности с выделенным расположением файлов данных.":::

1. Выберите **Сохранить**.

   :::image type="content" source="media/ADLS_new_entity_define_attributes.png" alt-text="Диалоговое окно для определения или автоматического создания атрибутов.":::

1. Выберите **определить атрибуты**, чтобы вручную добавить атрибуты, или выберите **автоматически создать их**. Чтобы определить атрибуты, введите имя, выберите формат данных и необязательный семантический тип. Чтобы автоматически создать атрибуты:

   1. После автоматического создания атрибутов выберите **Просмотреть атрибуты**. Открывается страница **Управление атрибутами**.

   1. Убедитесь, что формат данных правильный для каждого атрибута.

   1. Чтобы включить аналитику и другие возможности, выберите **Профилирование данных** для всей сущности или для определенных атрибутов. По умолчанию ни одна сущность не включена для профилирования данных.

      :::image type="content" source="media/dataprofiling-entities.png" alt-text="Диалоговое окно для выбора профилирования данных.":::

   1. Нажмите кнопку **Готово**. Отображается страница **Выберите сущности**.

1. Продолжайте добавлять сущности и атрибуты, если это применимо.

1. После добавления всех сущностей выберите **Включить**, чтобы включить сущности в прием источников данных.

   :::image type="content" source="media/ADLS_required.png" alt-text="Диалоговое окно, показывающее, что требуется для первичного ключа":::

1. Для выбранных сущностей, требующих инкрементного приема, **Обязательно** отображается в поле **Инкрементное обновление**. Для каждой из этих сущностей см. раздел [Настройка инкрементного обновления для источников данных Azure Data Lake](incremental-refresh-data-sources.md).

1. Для выбранных сущностей, для которых первичный ключ не определен, **Обязательно** отображается в поле **Первичный ключ**. Для каждой из этих сущностей:
   1. Выберите **Обязательно**. Открывается панель **Изменение сущности**.
   1. Выберите **первичный ключ**. Первичный ключ — это атрибут, уникальный для сущности. Чтобы атрибут был действительным первичным ключом, он не должен включать повторяющиеся значения, отсутствующие значения или значения NULL. В качестве первичных ключей поддерживаются атрибуты типа данных: строка, целое число, GUID.
   1. При желании измените шаблон раздела.
   1. Выберите **Закрыть**, чтобы сохранить и закрыть панель.

1. Выберите **Сохранить**. Открывается страница **Источники данных** с новым источником данных в статусе **Обновление**.

   [!INCLUDE [progress-details-include](includes/progress-details-pane.md)]

Загрузка данных может занять время. После успешного обновления принятые данные можно проверить на странице [**Сущности**](entities.md).

## <a name="edit-an-azure-data-lake-storage-data-source"></a>Редактирование источника данных Azure Data Lake Storage

Вы можете обновить параметр *Подключите свою учетную запись хранения с использованием*. Дополнительные сведения см. в разделе [Подключение Customer Insights к учетной записи Azure Data Lake Storage 2-го поколения с помощью субъекта-службы Azure](connect-service-principal.md). Чтобы подключиться к другому контейнеру из своей учетной записи хранилища или изменить имя учетной записи, [создайте новое соединение источника данных](#connect-to-azure-data-lake-storage).

1. Перейдите в раздел **Данные** > **Источники данных**.

1. Рядом с источником данных, который необходимо обновить, выберите **Изменить**.

   :::image type="content" source="media/data_sources_edit_ADLS.png" alt-text="Диалоговое окно для редактирования источника данных Azure Data Lake.":::

1. Измените любые из следующих сведений:

   - **Описание:**
   - **Подключите свою учетную запись хранения с использованием** и информацию о подключении. Невозможно изменить сведения **Контейнер** при обновлении соединения.
      > [!NOTE]
      > Учетной записи хранения или контейнеру должна быть назначена одна из следующих ролей:
        > - Средство чтения данных хранилища BLOB-объектов
        > - Владелец данных хранилища BLOB-объектов
        > - Участник данных хранилища BLOB-объектов

   - **Включить приватный канал**, если вы хотите принимать данные из учетной записи хранения через приватный канал Azure. Дополнительные сведения см. в разделе [Приватные каналы](security-overview.md#set-up-an-azure-private-link).

1. Выберите **Далее**.
1. Измените любое из следующего:
   - Перейдите к другому файлу model.json или manifest.json с другим набором сущностей из контейнера.
   - Чтобы добавить дополнительные сущности для приема, выберите **Новая сущность**.
   - Чтобы удалить любые уже выбранные сущности, если нет зависимостей, выберите сущность и выберите **Удалить**.
      > [!IMPORTANT]
      > Если существуют зависимости от существующего файла model.json или manifest.json и набора сущностей, вы увидите сообщение об ошибке и не сможете выбрать другой файл model.json или manifest.json. Удалите эти зависимости перед изменением файла model.json или manifest.json или создайте новый источник данных с файлом model.json или manifest.json, который вы хотите использовать, чтобы избежать удаления зависимостей.
   - Чтобы изменить расположение файла данных или первичный ключ, выберите **Изменить**.
   - Чтобы изменить данные добавочного приема, см. раздел [Настройка добавочного обновления для источников данных Azure Data Lake](incremental-refresh-data-sources.md).
   - Измените только имя сущности, чтобы оно соответствовало имени сущности в файле .json.

     > [!NOTE]
     > Всегда сохраняйте имя сущности в Customer Insights таким же, как имя сущности в файле model.json или manifest.json после приема. Customer Insights проверяет все имена сущностей с помощью model.json или manifest.json при каждом обновлении системы. Если имя сущности изменено либо внутри Customer Insights, либо вне его, возникает ошибка, поскольку Customer Insights не может найти новое имя сущности в JSON-файле. Если имя добавленной сущности было случайно изменено, отредактируйте имя сущности в Customer Insights, чтобы оно соответствовало имени в файле .json.

1. Выберите **Атрибуты** для добавления или изменения атрибутов или для включения профилирования данных. Затем выберите **Готово**.

1. Нажмите **Сохранить**, чтобы применить изменения и вернуться на страницу **Источники данных**.

   [!INCLUDE [progress-details-include](includes/progress-details-pane.md)]

## <a name="common-reasons-for-ingestion-errors-or-corrupt-data"></a>Распространенные причины ошибок приема или повреждения данных

Во время приема данных некоторые из наиболее распространенных причин, по которым запись может считаться поврежденной, включают:

- Типы данных и значения полей не совпадают между исходным файлом и схемой
- Количество столбцов в исходном файле не соответствует схеме
- Поля содержат символы, из-за которых столбцы перекашиваются по сравнению с ожидаемой схемой. Например: неправильно отформатированные кавычки, неэкранированные кавычки, символы новой строки или символы табуляции.
- Файлы разделов отсутствуют
- Если есть столбцы datetime/date/datetimeoffset, их формат необходимо указать в схеме, если он не соответствует стандартному формату.

### <a name="schema-or-data-type-mismatch"></a>Несоответствие схемы или типа данных

Если данные не соответствуют схеме, процесс приема завершается с ошибками. Исправьте либо исходные данные, либо схему, и повторите прием данных.

### <a name="partition-files-are-missing"></a>Файлы разделов отсутствуют

- Если прием прошел успешно без каких-либо поврежденных записей, но вы не видите никаких данных, отредактируйте файл model.json или manifest.json, чтобы убедиться, что указаны разделы. Затем [обновите источник данных](data-sources.md#refresh-data-sources).

- Если прием данных происходит одновременно с обновлением источников данных во время автоматического обновления по расписанию, файлы разделов могут быть пустыми или недоступными для обработки Customer Insights. Чтобы согласовать с расписанием обновления восходящего потока, измените [расписание обновления системы](schedule-refresh.md) или расписание обновления для источника данных. Выровняйте время так, чтобы обновления не происходили все одновременно и предоставляли самые последние данные для обработки в Customer Insights.

### <a name="datetime-fields-in-the-wrong-format"></a>Поля даты и времени в неправильном формате

Поля даты и времени в сущности не в форматах ISO 8601 или en-US. Формат даты и времени по умолчанию в Customer Insights — формат en-US. Все поля даты и времени в сущности должны быть в одном и том же формате. Customer Insights поддерживает другие форматы при условии, что аннотации или характеристики создаются на уровне источника или сущности в файле model или manifest.json. Например: 

**Model.json**

   ```json
      "annotations": [
        {
          "name": "ci:CustomTimestampFormat",
          "value": "yyyy-MM-dd'T'HH:mm:ss:SSS"
        },
        {
          "name": "ci:CustomDateFormat",
          "value": "yyyy-MM-dd"
        }
      ]   
   ```

  В файле manifest.json формат даты и времени можно указать на уровне сущности или на уровне атрибута. На уровне сущности используйте «exhibitsTraits» в сущности в *.manifest.cdm.json, чтобы определить формат даты и времени. На уровне атрибута используйте «appliedTraits» в атрибуте в entityname.cdm.json.

**Manifest.json на уровне сущности**

```json
"exhibitsTraits": [
    {
        "traitReference": "is.formatted.dateTime",
        "arguments": [
            {
                "name": "format",
                "value": "yyyy-MM-dd'T'HH:mm:ss"
            }
        ]
    },
    {
        "traitReference": "is.formatted.date",
        "arguments": [
            {
                "name": "format",
                "value": "yyyy-MM-dd"
            }
        ]
    }
]
```

**Entity.json на уровне атрибута**

```json
   {
      "name": "PurchasedOn",
      "appliedTraits": [
        {
          "traitReference": "is.formatted.date",
          "arguments" : [
            {
              "name": "format",
              "value": "yyyy-MM-dd"
            }
          ]
        },
        {
          "traitReference": "is.formatted.dateTime",
          "arguments" : [
            {
              "name": "format",
              "value": "yyyy-MM-ddTHH:mm:ss"
            }
          ]
        }
      ],
      "attributeContext": "POSPurchases/attributeContext/POSPurchases/PurchasedOn",
      "dataFormat": "DateTime"
    }
```

[!INCLUDE [footer-include](includes/footer-banner.md)]
